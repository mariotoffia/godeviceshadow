:author_name: Mario Toffia
:author_email: no.spam@please
:author: {author_name}
:email: {author_email}
:source-highlighter: highlightjs
ifndef::icons[:icons: font]
ifndef::imagesdir[:imagesdir: ../meta/assets]
:toc:
:toclevels: 3

= Examples
Some examples how to use the library and it's functionality.

== Merge Package
This shows how to use and expect from the merge package.

.Merging
[source,go]
----
func TestMerge(t *testing.T) {
	parse := func(s string) time.Time {
		if tm, err := time.Parse(time.RFC3339, s); err == nil {
			return tm
		} else {
			t.Fatal(err)

			return time.Time{}
		}
	}

	hubZero := HomeTemperatureHub{ // <1>
		DeviceShadow: DeviceShadow{
			TimeZone: "Europe/Stockholm",
			Owner:    "mariotoffia",
		},
		ClimateSensors: ClimateSensors{
			Indoor: map[string]IndoorTemperatureSensor{
				"living_room": {
					Floor:       1,
					Direction:   DirectionNorth,
					Temperature: 22.6,
					UpdatedAt:   parse("2023-01-01T10:00:00+01:00"),
					Humidity:    32.0,
				},
			},
		},
	}

	hub := HomeTemperatureHub{ // <2>
		DeviceShadow: DeviceShadow{
			TimeZone: "Europe/Stockholm",
			Owner:    "mariotoffia",
		},
		ClimateSensors: ClimateSensors{
			Outdoor: map[string]OutdoorTemperatureSensor{
				"garden": {
					Direction:   DirectionNorth,
					Temperature: -27.0,
					UpdatedAt:   parse("2023-01-01T12:00:00+01:00"),
					Humidity:    17.0,
				},
			},
			Indoor: map[string]IndoorTemperatureSensor{
				"living_room": {
					Floor:       1,
					Direction:   DirectionNorth,
					Temperature: 22.6,
					UpdatedAt:   parse("2023-01-01T11:55:00+01:00"),
					Humidity:    32.0,
				},
				"basement": {
					Floor:       0,
					Direction:   DirectionSouth,
					Temperature: 18.0,
					UpdatedAt:   parse("2023-01-01T11:00:00+01:00"),
					Humidity:    40.0,
				},
			},
		},
	}

	sl := strlogger.NewStringLogger() // <3>

	res, err := merge.Merge(hubZero, hub, merge.MergeOptions{
		Mode:    merge.ServerIsMaster,   // <4>
		Loggers: merge.MergeLoggers{sl}, // <5>
	})
	require.NoError(t, err)
	assert.Equal(t, hub, res) // <6>

	fmt.Println(sl.String())
}
----
<1> This is the baseline (e.g. gotten from _DynamoDB_)
<2> Acts as the update to the device shadow.
<3> Simple logger that logs each merge event in a single row (good for debugging)
<4> No deletion is possible only: add, update and no change are permitted (use `ClientIsMaster` to allow deletions)
<5> It is possible to have multiple merge loggers attached e.g. one to log, one to update _Amazon Aurora DSQL_ table and so on.
<6> In this case we are in suync with latest, but where there any deletes in _res_, those would not been propagated.